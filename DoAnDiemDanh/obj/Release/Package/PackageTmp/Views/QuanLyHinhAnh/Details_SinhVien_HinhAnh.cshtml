@using DoAnDiemDanh.Models
@model IEnumerable<HINHANH>
@{
    ViewBag.Title = "Details_SinhVien_HinhAnh";
    Layout = "~/Views/Layout/_LayoutAdmin.cshtml";
    
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index","DiemDanh")">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="@Url.Action("Index","QuanLySinhVien")">Quản lý sinh viên</a></li>
        <li class="breadcrumb-item " aria-current="page">Hình ảnh train</li>
    </ol>
</nav>
<div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
    <div class="modal-dialog" role="document" style="background-color: white;"  id="formchupanh">
        <div class="modal-content" style="width: 609px;" >
            <div class="form-horizontal  p-3 form-avatar">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <div class="form-group camera ">
                    <div class="h3 mb-2 ml-2 text-gray-800" style="font-size: 20px; font-weight: 600;">Hình ảnh</div>
                    <div class="h3 mb-2 ml-2 text-gray-800" style="font-size: 16px; font-weight: 400;">Click button để chup ảnh</div>
                    <div>
                        <div class="row">
                            <div class="col-12" id="video">
                                @*<video id="stream" width="320" height="300"></video>*@
                                @*<iframe src="https://g3.ipcamlive.com/player/player.php?alias=60c9be7f62715" width="576" height="324" id="cameraip" />*@
                                <iframe width="560" height="315" src="https://www.youtube.com/embed/W5PwTEnQNAg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen id="cameraip"></iframe>
                            </div>
                            <div class="col-7">
                                <div class="card shadow mb-4">
                                    <div class="card-header py-3">
                                        <h6 class="m-0 font-weight-bold text-primary" id="soluong">0 images</h6>
                                    </div>
                                    <div class="card-body" style="position: relative; display: block; overflow: scroll; height: 250px; padding: 0px; padding-left: 20px;" id="hinhanh_cam">
                                       
                                    </div>
                                </div>

                            </div>
                            <div class="col-3">
                                <span class="btn btn-success btn-icon-split m-2" id="btn-capture" style="margin-left: 10px;">
                                    <span class="text">Chụp Hình</span>
                                </span>
                                <span class="btn btn-success btn-icon-split m-2" id="btn-save" style="margin-left: 10px; width: 100px;">
                                    <span class="text">Lưu ảnh</span>
                                </span>
                            </div>
                        </div>
                    </div>

                   

                </div>

            </div>

        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Danh sách hình ảnh train của sinh viên @ViewBag.TenSV</h6>
    </div>
    <div class="card-body" style="position: relative; display: flex; overflow:scroll" id="card_hinhanh">
        @Html.AntiForgeryToken()
        @foreach (var item in Model)
        {
        <div id="hinhanh_@item.MaHA" style="margin-right: 10px; ">
            <a data-ajax="true" data-ajax-confirm="Bạn có muốn hình ảnh này ?" data-ajax-method="POST" data-ajax-success="deleteSuccess" href="@Url.Action("Delete","QuanLyHinhAnh",new {id=item.MaHA })">
                <span class="icon" style=" z-index: 999; position: absolute; margin-left: 63px; color: #6784D9;">
                    <i class="fas fa-times"></i>
                </span>
            </a>

            <a href="~/Content/img/@item.TenHA" data-toggle="lightbox">
                <img src="~/Content/img/@item.TenHA" style="width: 80px; height: auto;  border-radius: 5px;" />
            </a>
            
        </div>

        }
    </div>
</div>

@using (Ajax.BeginForm("Details_SinhVien_HinhAnh", "QuanLyHinhAnh", new AjaxOptions { HttpMethod = "POST", OnSuccess = "FnSuccess" }, new { id = ViewBag.MaSV, enctype = "multipart/form-data" }))
{
    <div class="row uploadanh1" style="text-align: center">
        <div class="col-xl-6 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class=" font-weight-bold text-primary text-uppercase mb-1">
                                Chọn hình ảnh để train
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                <img src="~/Content/img/photo.png" alt="avatar" style="width: 80px; height:auto; z-index: -999" />
                                <input type="file" name="Avatar" accept="image/*" required id="upload" class="custom-file-input" onchange="loadFile(event)" style="position: absolute; left: -22px; top: 39px;" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row uploadanh2" style="text-align: center">
        <div class="col-xl-6 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="h5 mb-0 font-weight-bold text-gray-800" style="text-align: center">
                                <img alt="avatar" style="width: 125px; height:auto; z-index: -999;" id="output" src="~/Content/img/white.jpg"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="submit" value="Thêm mới" class="btn btn-success btn-icon-split p-2 border submit" />
    <Button class="btn btn-success btn-icon-split shadow" data-toggle="modal" data-target="#exampleModalLong" id="open">
        <span class="icon text-white-50">
            <i class="fas fa-plus"></i>
        </span>
        <span class="text">Webcame</span>
    </Button>
}

<script>
    $(document).ready(function () {
        if ($(window).width() < 480) {
            $('.uploadanh1').addClass('d-none')
            $('.uploadanh2').addClass('d-none')
            $('.submit').addClass('d-none')
        }
    })
   

    var loadFile = function (event) {
        var image = document.getElementById('output');
        image.src = URL.createObjectURL(event.target.files[0])
    }

    function FnSuccess(data) {
        if (data != false) {
            var hinhanh = `<div id="hinhanh_${data.MaHA}" style="margin-right: 10px;">
                                <a data-ajax="true" data-ajax-confirm="Bạn có muốn hình ảnh này ?" data-ajax-method="POST" data-ajax-success="deleteSuccess" href="/QuanLyHinhAnh/Delete/${data.MaHA}">
                                    <span class="icon" style=" z-index: 999; position: absolute; margin-left: 63px; color: #6784D9;">
                                        <i class="fas fa-times"></i>
                                    </span>
                                </a>
                                <a href="../../Content/img/${data.TenHA}" data-toggle="lightbox">
                                    <img src="../../Content/img/${data.TenHA}" style="width: 80px; height: auto;  border-radius: 5px;" />
                                </a>
                            </div>`;
            $('#card_hinhanh').append(hinhanh);
            $('#upload').val("");
            $('#output').attr("src", "");
            Swal.fire({
                icon: 'success',
                title: 'Thành Công',
                text: `Upload ảnh thành công`,
                timer: 2000,
                showConfirmButton: false

            })
        }
    }

    function deleteSuccess(data) {

        $(`#hinhanh_${data}`).remove()
        Swal.fire({
            icon: 'success',
            title: 'Thành Công',
            text: `Xóa ảnh thành công`,
            timer: 2000,
            showConfirmButton: false
        })
    }

    function alertSuccess() {
        $('.alert').addClass("show");
        $('.alert').removeClass("hide");
        $('.alert').addClass("showAlert");
        setTimeout(function () {
            $('.alert').removeClass("show");
            $('.alert').addClass("hide");
        }, 5000);
        $('.close-btn').click(function () {
            $('.alert').removeClass("show");
            $('.alert').addClass("hide");
        });
    }

    function getAttrFromString(str, node, attr) {
        var regex = new RegExp('<' + node + ' .*?' + attr + '="(.*?)"', "gi"), result, res = [];
        while ((result = regex.exec(str))) {
            res.push(result[1].substr(22, result[1].length));
        }
        return res;
    }

    var stream = document.getElementById("stream");
    var capture = document.getElementById("capture");
    var soluong = 0;

    var cameraStream = null;

    //$("#open").click(function () {
    //    $("#cameraip")[0].src += ";autoplay=1"
    //})

    //$("#open").click(function () {

    //    var mediaSupport = 'mediaDevices' in navigator;
    //    if (mediaSupport && null == cameraStream) {

    //        navigator.mediaDevices.getUserMedia({ video: true })
    //            .then(function (mediaStream) {
    //                cameraStream = mediaStream;
    //                stream.srcObject = mediaStream;
    //                stream.play();
    //            })
    //            .catch(function (err) {
    //                console.log("Unable to access camera: " + err);
    //            });
    //    }
    //    else {
    //        Swal.fire({
    //            icon: 'warning',
    //            title: 'Camera không được truy cập',
    //            text: `Hãy cấp quyền bật camera trên trình duyệt`,
    //            timer: 2000,
    //            showConfirmButton: false

    //        })
    //        return;
    //    }
    //});

    //$(".close").click(function () {
    //    if (null != cameraStream) {
    //        var track = cameraStream.getTracks()[0];
    //        track.stop();
    //        stream.load();
    //        cameraStream = null;
    //    }
    //});

    $("#btn-capture").click(startMouseCount)
   
    $("#btn-save").click(() => {
        $(".close").click();

        if (null != cameraStream) {
            var track = cameraStream.getTracks()[0];
            track.stop();
            stream.load();
            cameraStream = null;
        }

        var s = getAttrFromString($('#hinhanh_cam').html(), 'img', 'src');

        $.ajax({
            type: 'POST',
            url: "/QuanLyHinhAnh/Webcam",
            data: { id: @ViewBag.MaSV, data: s },
            beforeSend: () => { $('.loader-wrapper').show() },
            complete: () => { $('.loader-wrapper').hide()},
            success: function (data) {
                $('#hinhanh_cam').empty();

                Swal.fire({
                    icon: 'success',
                    title: 'Thành Công',
                    text: `Chụp ảnh và upload thành công`,
                    timer: 2000,
                    showConfirmButton: false

                })
                $.each(data, function (index, value) {
                    var row = `<div id="hinhanh_${value.maanh}" style="margin-right: 10px; ">
                                    <a data-ajax="true" data-ajax-confirm="Bạn có muốn hình ảnh này ?" data-ajax-method="POST" data-ajax-success="deleteSuccess" href="/QuanLyHinhAnh/Delete/${value.maanh}">
                                        <span class="icon" style=" z-index: 999; position: absolute; margin-left: 63px; color: #6784D9;">
                                            <i class="fas fa-times"></i>
                                        </span>
                                    </a>
                                    <a href="../../Content/img/${value.tenanh}" data-toggle="lightbox">
                                    <img src="../../Content/img/${value.tenanh}" style="width: 80px; height: auto;  border-radius: 5px;" />
                                </a>
                                </div>`
                    $('#card_hinhanh').append(row)
                })
                Swal.fire({
                    icon: 'success',
                    title: 'Thành Công',
                    text: `Chụp Ảnh và Upload thành công`,
                    timer: 2000,
                    showConfirmButton: false

                })

            }
        });

    })

    var mouseDownCount = 0


    

    function startMouseCount() {
      
        html2canvas(document.querySelector("#video")).then(canvas => {
                  
                var img = new Image()
                  

                img.src = canvas.toDataURL("image/png");
                
                img.width = 60;
                img.height = 45;
                img.style = "margin: 2px; border-radius: 5px; border: 1px black solid;"
                soluong += 1;

                $("#hinhanh_cam").append(img);
                $("#hinhanh_cam").scrollTop($("#hinhanh_cam")[0].scrollHeight);
            });
        
           
       
    }

    function stopMouseCount() {
        clearTimeout(mdcTimer);
    }

    $(document).on('click', '[data-toggle="lightbox"]', function (event) {
        event.preventDefault();
        $(this).ekkoLightbox();
    });


</script>
