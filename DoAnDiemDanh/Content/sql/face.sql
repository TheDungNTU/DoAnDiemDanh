CREATE DATABASE FACE_RECOGNITION
GO

USE FACE_RECOGNITION
GO

CREATE TABLE KHOA(
	MaKhoa INT IDENTITY(1,1) PRIMARY KEY , 
	TenKhoa NVARCHAR(200) NOT NULL
)
GO

CREATE TABLE LOP(
	MaLop INT IDENTITY(1,1) PRIMARY KEY,
	TenLop VARCHAR(100),
	MaKhoa INT CONSTRAINT FK_LOP_KHOA FOREIGN KEY REFERENCES dbo.KHOA(MaKhoa) ON DELETE CASCADE
)
GO

CREATE TABLE GIANGVIEN(
	MaGV INT IDENTITY(1,1) PRIMARY KEY,
	TenGV NVARCHAR(200),
	Email VARCHAR(500),
	MaKhoa INT CONSTRAINT FK_GIANGVIEN_KHOA FOREIGN KEY REFERENCES dbo.KHOA(MaKhoa) ON DELETE CASCADE
)
GO

CREATE TABLE QUYEN(
	MaQuyen INT IDENTITY(1,1) PRIMARY KEY,
	TenQuyen VARCHAR(100),
	GhiChu NVARCHAR(500),
)

CREATE TABLE TAIKHOAN(
	TaiKhoan VARCHAR(500) PRIMARY KEY,
	MatKhau VARCHAR(100),
	MaGV INT FOREIGN KEY REFERENCES dbo.GIANGVIEN(MaGV) ON DELETE CASCADE,
	MaQuyen INT FOREIGN KEY REFERENCES dbo.QUYEN(MaQuyen) ON DELETE CASCADE,
)
GO

CREATE TABLE SINHVIEN(
	MaSV INT IDENTITY(1,1) PRIMARY KEY,
	TenSV NVARCHAR(200),
	MaKhoa INT CONSTRAINT FK_SINHVIEN_KHOA FOREIGN KEY REFERENCES dbo.KHOA(MaKhoa) ON DELETE CASCADE,
	MaLop INT CONSTRAINT FK_SINHVIEN_LOP FOREIGN KEY REFERENCES dbo.LOP(MaLop)
)
GO

CREATE TABLE MONHOC(
	MaMH INT IDENTITY(1,1) PRIMARY KEY,
	TenMH NVARCHAR(200),
	SoTC INT,
	NgayBD DATE,
	NgayKT DATE,
	ThoiGianBDGD TIME,
	ThoiGianKTGD TIME,
	MaGV INT CONSTRAINT FK_MONHOC_GIANGVIEN FOREIGN KEY REFERENCES dbo.GIANGVIEN(MaGV) ON DELETE CASCADE
)
GO

CREATE TABLE DIEMDANH(
	MaDD INT IDENTITY(1,1) PRIMARY KEY,
	MaMH INT CONSTRAINT FK_DIEMDANH_MONHOC FOREIGN KEY REFERENCES dbo.MONHOC(MaMH) ON DELETE CASCADE ON UPDATE CASCADE,
	NgayDiemDanh DATE
)
GO

CREATE TABLE SINHVIEN_MONHOC(
	MaSV INT CONSTRAINT FK_SINHVIEN_MONHOC_1 FOREIGN KEY REFERENCES dbo.SINHVIEN(MaSV) ON DELETE CASCADE,
	MaMH INT CONSTRAINT FK_SINHVIEN_MONHOC_2 FOREIGN KEY REFERENCES dbo.MONHOC(MaMH),
	PRIMARY KEY (MaSV,MaMH)
)
GO

CREATE TABLE CTDD(
	MaDD INT CONSTRAINT FK_CTDD_DD FOREIGN KEY REFERENCES dbo.DIEMDANH(MaDD) ON DELETE CASCADE ON UPDATE CASCADE NOT NULL,
	PRIMARY KEY(MaDD,MaSV),
	MaSV INT CONSTRAINT FK_CTDD_SINHVIEN FOREIGN KEY REFERENCES dbo.SINHVIEN(MaSV),
	ThoiGianVao TIME,
	ThoiGianRa TIME,
	TTDD BIT DEFAULT 0
)
GO

CREATE TABLE HINHANH(
	MaHA INT IDENTITY(1,1) PRIMARY KEY,
	TenHA VARCHAR(500),
	BASE64 VARCHAR(MAX),
	MaSV INT CONSTRAINT FK_HINHANH_SINHVIEN FOREIGN KEY REFERENCES dbo.SINHVIEN(MaSV) ON UPDATE CASCADE ON DELETE CASCADE
)
GO

CREATE TABLE DIEMDANH_T(
	MaDD INT IDENTITY(1,1) PRIMARY KEY,
	MaSV INT FOREIGN KEY REFERENCES dbo.SINHVIEN(MaSV) ON UPDATE CASCADE ON DELETE CASCADE,
	Ngay DATE DEFAULT GETDATE(),
	Gio TIME DEFAULT GETDATE()
)

CREATE TABLE NGAYLE(
	MaNL INT IDENTITY(1,1) PRIMARY KEY,
	TenNL VARCHAR(MAX),
	Ngay DATE,
	GhiChu VARCHAR(MAX)
)

CREATE TABLE THOIKHOABIEU(
	MaMH INT PRIMARY KEY,
	ThuHai BIT DEFAULT 0,
	ThuBa BIT DEFAULT 0,
	ThuTu BIT DEFAULT 0,
	ThuNam BIT DEFAULT 0,
	ThuSau BIT DEFAULT 0,
	ThuBay BIT DEFAULT 0,
	CONSTRAINT FK_TKB_MH FOREIGN KEY(MaMH) REFERENCES dbo.MONHOC(MaMH) ON DELETE CASCADE
) 


---------------------------------------------------------------------------------------------------------------------------------

CREATE TRIGGER trg_DiemDanh ON dbo.DIEMDANH_T AFTER INSERT AS 
BEGIN
	DECLARE @Ngay DATE = (SELECT Inserted.Ngay FROM Inserted)
	DECLARE @Gio TIME = (SELECT Inserted.Gio FROM Inserted)
	DECLARE @MaDD1 INT
	DECLARE @MaSV1 INT
	DECLARE @MaDD2 INT
	DECLARE @MaSV2 INT

	SET  @MaDD1  = (SELECT DISTINCT CTDD.MaDD
				   FROM Inserted JOIN dbo.SINHVIEN_MONHOC ON SINHVIEN_MONHOC.MaSV = Inserted.MaSV
								JOIN dbo.MONHOC ON MONHOC.MaMH = SINHVIEN_MONHOC.MaMH
								JOIN dbo.DIEMDANH ON DIEMDANH.MaMH = MONHOC.MaMH
								JOIN dbo.CTDD ON CTDD.MaDD = DIEMDANH.MaDD
				   WHERE Inserted.Gio >= CONVERT(time, dbo.MONHOC.ThoiGianBDGD) AND Inserted.Gio <= DATEADD(MINUTE,15,CONVERT(time, dbo.MONHOC.ThoiGianBDGD)) AND Inserted.Ngay = dbo.DIEMDANH.NgayDiemDanh AND Inserted.MaSV = CTDD.MaSV AND CTDD.ThoiGianVao IS NULL)
	SET @MaSV1 =   (SELECT DISTINCT dbo.CTDD.MaSV
					FROM Inserted JOIN dbo.SINHVIEN_MONHOC ON SINHVIEN_MONHOC.MaSV = Inserted.MaSV
							JOIN dbo.MONHOC ON MONHOC.MaMH = SINHVIEN_MONHOC.MaMH
							JOIN dbo.DIEMDANH ON DIEMDANH.MaMH = MONHOC.MaMH
							JOIN dbo.CTDD ON CTDD.MaDD = DIEMDANH.MaDD
					WHERE Inserted.Gio >= CONVERT(time, dbo.MONHOC.ThoiGianBDGD) AND Inserted.Gio <= DATEADD(MINUTE,15,CONVERT(time, dbo.MONHOC.ThoiGianBDGD)) AND Inserted.Ngay = dbo.DIEMDANH.NgayDiemDanh AND Inserted.MaSV = CTDD.MaSV AND CTDD.ThoiGianVao IS NULL)

	SET  @MaDD2  = (SELECT DISTINCT CTDD.MaDD
				   FROM Inserted JOIN dbo.SINHVIEN_MONHOC ON SINHVIEN_MONHOC.MaSV = Inserted.MaSV
								JOIN dbo.MONHOC ON MONHOC.MaMH = SINHVIEN_MONHOC.MaMH
								JOIN dbo.DIEMDANH ON DIEMDANH.MaMH = MONHOC.MaMH
								JOIN dbo.CTDD ON CTDD.MaDD = DIEMDANH.MaDD
				   WHERE Inserted.Gio >= DATEADD(MINUTE,-15,CONVERT(time, dbo.MONHOC.ThoiGianKTGD)) AND Inserted.Gio <= CONVERT(time, dbo.MONHOC.ThoiGianKTGD) AND Inserted.Ngay = dbo.DIEMDANH.NgayDiemDanh AND Inserted.MaSV = CTDD.MaSV AND CTDD.ThoiGianVao IS NOT NULL)
	SET @MaSV2 =   (SELECT DISTINCT dbo.CTDD.MaSV
					FROM Inserted JOIN dbo.SINHVIEN_MONHOC ON SINHVIEN_MONHOC.MaSV = Inserted.MaSV
							JOIN dbo.MONHOC ON MONHOC.MaMH = SINHVIEN_MONHOC.MaMH
							JOIN dbo.DIEMDANH ON DIEMDANH.MaMH = MONHOC.MaMH
							JOIN dbo.CTDD ON CTDD.MaDD = DIEMDANH.MaDD
					WHERE Inserted.Gio >= DATEADD(MINUTE,-15,CONVERT(time, dbo.MONHOC.ThoiGianKTGD)) AND Inserted.Gio <= CONVERT(time, dbo.MONHOC.ThoiGianKTGD) AND Inserted.Ngay = dbo.DIEMDANH.NgayDiemDanh AND Inserted.MaSV = CTDD.MaSV AND CTDD.ThoiGianVao IS NOT NULL)

	IF(@MaDD1 IS NOT NULL AND @MaSV1 IS NOT NULL)
	BEGIN
		UPDATE dbo.CTDD
		SET TTDD = 0,
			ThoiGianVao = @Gio
		WHERE MaSV = @MaSV1 AND MaDD = @MaDD1
	END
	ELSE
		UPDATE dbo.CTDD
		SET TTDD = 1,
			ThoiGianRa = @Gio
		WHERE MaSV = @MaSV2 AND MaDD = @MaDD2
END
GO

----------------------------------------------------------------------------------------------------------------------------------
SELECT * FROM dbo.TAIKHOAN

SELECT *  FROM dbo.QUYEN

SELECT * FROM dbo.TAIKHOAN tk
		 JOIN dbo.QUYEN q ON	q.MaQuyen = tk.MaQuyen
		 WHERE tk.TaiKhoan = 'thedung6332@gmail.com'